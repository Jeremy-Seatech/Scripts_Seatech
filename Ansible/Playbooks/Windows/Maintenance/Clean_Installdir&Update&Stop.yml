---
- name: Clean_installdir&Stop
  hosts: all
  gather_facts: no
  tasks:
    - name: Clean_installdir&Stop
      ansible.windows.win_powershell:
        script: |
          # COPIER SCRIPT CI-DESSOUS
          ################ Suppression du dossier C:\install ################

          $folderPath = "C:\install"
  
          # VÃ©rifie si le dossier existe
          if (Test-Path $folderPath) {
              # Supprime le dossier et son contenu
              Remove-Item -Path $folderPath -Recurse -Force
              Write-Host "Le dossier $folderPath a Ã©tÃ© supprimÃ© avec succÃ¨s."
          } else {
              Write-Host "Le dossier $folderPath n'existe pas."
          }
          
          
          
          
          ################ Mise a jour & Arret ################
          
          # CrÃ©ation de l'objet COM pour Windows Update
          $UpdateSession = New-Object -ComObject Microsoft.Update.Session
          $UpdateSearcher = $UpdateSession.CreateUpdateSearcher()
          
          # Recherche des mises Ã  jour
          Write-Host "Recherche des mises Ã  jour..."
          $SearchResult = $UpdateSearcher.Search("IsInstalled=0 and Type='Software' and IsHidden=0")
          
          # VÃ©rification si des mises Ã  jour sont disponibles
          if ($SearchResult.Updates.Count -eq 0) {
              Write-Host "Aucune mise Ã  jour disponible."
              exit
          }
          
          # Affichage du nombre de mises Ã  jour trouvÃ©es
          Write-Host "Nombre de mises Ã  jour trouvÃ©es : $($SearchResult.Updates.Count)"
          
          # CrÃ©ation d'une collection pour les mises Ã  jour Ã  installer
          $UpdatesToDownload = New-Object -ComObject Microsoft.Update.UpdateColl
          
          # Ajout des mises Ã  jour Ã  la collection
          foreach ($Update in $SearchResult.Updates) {
              $UpdatesToDownload.Add($Update) | Out-Null
              Write-Host "Ajout de la mise Ã  jour : $($Update.Title)"
          }
          
          # TÃ©lÃ©chargement des mises Ã  jour
          Write-Host "TÃ©lÃ©chargement des mises Ã  jour..."
          $Downloader = $UpdateSession.CreateUpdateDownloader()
          $Downloader.Updates = $UpdatesToDownload
          $DownloadResult = $Downloader.Download()
          
          # Installation des mises Ã  jour
          Write-Host "Installation des mises Ã  jour..."
          $Installer = $UpdateSession.CreateUpdateInstaller()
          $Installer.Updates = $UpdatesToDownload
          $InstallResult = $Installer.Install()
          
          # ArrÃªter la machine
          Stop-Computer -Force
